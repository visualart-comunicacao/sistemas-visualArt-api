generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

enum OrderStatus {
  PENDING
  PAID
  CANCELED
  SHIPPED
  DELIVERED
}

enum OrderType {
  QUOTE
  SALE
  INTERNAL
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  REFUNDED
  CANCELED
}

enum PricingModel {
  UNIT
  AREA_M2
  LINEAR_M
  QUOTE
}

enum DimensionUnit {
  MM
  CM
}

enum PriceModifierType {
  FIXED_CENTS
  PER_M2_CENTS
  PERCENT
}

enum AddressType {
  SHIPPING
  BILLING
}

enum CustomerType {
  PERSON
  BUSINESS
}

enum Gender {
  NOT_INFORMED
  MALE
  FEMALE
  OTHER
}

model User {
  id       String   @id @default(cuid())
  name     String
  email    String?  @unique
  password String?
  role     UserRole @default(CUSTOMER)

  isActive  Boolean @default(true)
  isErpOnly Boolean @default(false)

  phone    String?
  document String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  addresses Address[]
  orders    Order[]
  profile   CustomerProfile?

  // ✅ WhatsApp Inbox (tickets atribuídos ao usuário/atendente)
  tickets Ticket[]

  @@index([role])
  @@index([isErpOnly])
}

model Address {
  id     String @id @default(cuid())
  userId String

  type      AddressType @default(SHIPPING)
  isDefault Boolean     @default(false)

  label      String?
  recipient  String?
  zipCode    String
  street     String
  number     String
  complement String?
  district   String
  city       String
  state      String
  reference  String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([zipCode])
  @@index([type])
}

model Category {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@index([name])
}

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  active      Boolean @default(true)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  pricingModel PricingModel @default(AREA_M2)

  dimensionUnit DimensionUnit @default(CM)
  minWidth      Int?
  maxWidth      Int?
  minHeight     Int?
  maxHeight     Int?
  step          Int?

  minAreaM2     Float?
  minPriceCents Int?

  baseUnitPriceCents    Int?
  baseM2PriceCents      Int?
  baseLinearMPriceCents Int?

  images       ProductImage[]
  optionGroups ProductOptionGroup[]
  stock        Stock?

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
  @@index([categoryId])
  @@index([name])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  alt       String?

  isCover   Boolean @default(false)
  sortOrder Int     @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([isCover])
  @@index([sortOrder])
}

model ProductOptionGroup {
  id        String  @id @default(cuid())
  productId String
  name      String
  required  Boolean @default(false)
  minSelect Int     @default(0)
  maxSelect Int     @default(1)
  sortOrder Int     @default(0)

  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  options ProductOption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([sortOrder])
}

model ProductOption {
  id        String  @id @default(cuid())
  groupId   String
  name      String
  active    Boolean @default(true)
  sortOrder Int     @default(0)

  modifierType  PriceModifierType @default(FIXED_CENTS)
  modifierValue Int               @default(0)

  group ProductOptionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([groupId])
  @@index([active])
  @@index([sortOrder])
}

model Stock {
  id        String @id @default(cuid())
  productId String @unique
  quantity  Int    @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id     String @id @default(cuid())
  userId String

  code          String        @unique
  type          OrderType     @default(QUOTE)
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(UNPAID)

  subtotalCents Int @default(0)
  discountCents Int @default(0)
  shippingCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int

  notes         String?
  internalNotes String?

  approvedAt DateTime?
  canceledAt DateTime?

  sourceQuoteId String? @unique
  sourceQuote   Order?  @relation("QuoteToSale", fields: [sourceQuoteId], references: [id])
  saleFromQuote Order?  @relation("QuoteToSale")

  user  User        @relation(fields: [userId], references: [id], onDelete: Restrict)
  items OrderItem[]

  payments  Payment[]
  workOrder WorkOrder?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String

  name       String
  priceCents Int
  quantity   Int

  width     Int?
  height    Int?
  optionIds String[] @default([])

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  WorkOrderItem WorkOrderItem[]

  @@index([orderId])
  @@index([productId])
}

model CustomerProfile {
  id     String @id @default(cuid())
  userId String @unique

  type CustomerType @default(PERSON)

  fullName  String?
  birthDate DateTime?
  gender    Gender    @default(NOT_INFORMED)

  companyName    String?
  tradeName      String?
  stateTaxId     String?
  municipalTaxId String?

  cpf  String? @unique
  cnpj String? @unique
  rg   String?

  phone2   String?
  whatsapp Boolean @default(true)

  marketingOptIn  Boolean   @default(false)
  termsAcceptedAt DateTime?

  notes     String?
  isBlocked Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([isBlocked])
}

model Sequence {
  id    String @id @default(cuid())
  key   String
  year  Int
  value Int    @default(0)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([key, year])
  @@index([year])
}

enum WorkOrderStatus {
  OPEN
  IN_PRODUCTION
  WAITING_CUSTOMER
  READY
  DELIVERED
  CANCELED
}

enum PaymentMethod {
  CASH
  PIX
  CREDIT_CARD
  DEBIT_CARD
  BOLETO
  TRANSFER
  OTHER
}

model Payment {
  id          String        @id @default(cuid())
  orderId     String
  amountCents Int
  method      PaymentMethod
  paidAt      DateTime      @default(now())
  notes       String?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([paidAt])
  @@index([method])
}

model WorkOrder {
  id      String          @id @default(cuid())
  code    String          @unique
  orderId String          @unique
  status  WorkOrderStatus @default(OPEN)

  dueAt         DateTime?
  priority      Int       @default(0)
  instructions  String?
  internalNotes String?

  order Order           @relation(fields: [orderId], references: [id], onDelete: Restrict)
  items WorkOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

model WorkOrderItem {
  id          String @id @default(cuid())
  workOrderId String
  orderItemId String

  status WorkOrderStatus @default(OPEN)
  notes  String?

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Restrict)

  @@index([workOrderId])
  @@index([orderItemId])
}

//
// ==============================
// ✅ WhatsApp Inbox (Meta Cloud API)
// ==============================
//

enum Channel {
  WHATSAPP
}

enum TicketStatus {
  OPEN
  PENDING
  CLOSED
}

enum MessageDirection {
  IN
  OUT
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  AUDIO
  VIDEO
  STICKER
  UNKNOWN
}

enum MessageStatus {
  RECEIVED
  SENT
  DELIVERED
  READ
  FAILED
}

model Contact {
  id      String  @id @default(cuid())
  channel Channel @default(WHATSAPP)

  // Identificadores do WhatsApp (Meta)
  waId      String  @unique // wa_id do usuário (cliente) na Meta
  phoneE164 String?
  name      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tickets Ticket[]
}

model Ticket {
  id      String       @id @default(cuid())
  channel Channel      @default(WHATSAPP)
  status  TicketStatus @default(OPEN)

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // ✅ Atendente responsável (se null => fila "Espera")
  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id], onDelete: SetNull)

  lastMessageAt DateTime?
  waWindowUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]

  @@index([assignedToId])
  @@index([status, lastMessageAt])
  @@index([contactId, status])
}

model Message {
  id       String @id @default(cuid())
  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  direction MessageDirection
  type      MessageType      @default(TEXT)

  text     String?
  mediaUrl String?
  mimeType String?

  // id da mensagem na Meta (quando houver)
  providerMessageId String? @unique

  status MessageStatus @default(RECEIVED)

  createdAt DateTime @default(now())

  @@index([ticketId, createdAt])
}
